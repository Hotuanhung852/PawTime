<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PawTime</title>
  <link rel="stylesheet" href="../assets/css/viewbookingservice.css">
  <script type="text/javascript" src="../assets/js/app.js" defer></script>
  <!-- 
    - favicon
  -->
  <link rel="shortcut icon" href="../favicon.svg" type="image/svg+xml">
  <!-- Font Awesome CDN-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
</head>

<body>
  <nav id="sidebar">
    <ul>
      <li>
        <span class="logo">PawTime</span>
        <button onclick=toggleSidebar() id="toggle-btn">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed">
            <path
              d="m313-480 155 156q11 11 11.5 27.5T468-268q-11 11-28 11t-28-11L228-452q-6-6-8.5-13t-2.5-15q0-8 2.5-15t8.5-13l184-184q11-11 27.5-11.5T468-692q11 11 11 28t-11 28L313-480Zm264 0 155 156q11 11 11.5 27.5T732-268q-11 11-28 11t-28-11L492-452q-6-6-8.5-13t-2.5-15q0-8 2.5-15t8.5-13l184-184q11-11 27.5-11.5T732-692q11 11 11 28t-11 28L577-480Z" />
          </svg>
        </button>
      </li>
      <li>
        <a href="PetBoarding.html">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed">
            <path
              d="M160-120q-33 0-56.5-23.5T80-200v-440q0-33 23.5-56.5T160-720h160v-80q0-33 23.5-56.5T400-880h160q33 0 56.5 23.5T640-800v80h160q33 0 56.5 23.5T880-640v440q0 33-23.5 56.5T800-120H160Zm240-600h160v-80H400v80Zm-160 80h-80v440h80v-440Zm400 440v-440H320v440h320Zm80-440v440h80v-440h-80ZM480-420Z" />
          </svg>
          <span>Pet Boarding</span>
        </a>
      </li>
      <li>
        <a href="HouseSitting.html">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed">
            <path
              d="M160-120v-375l-72 55-48-64 120-92v-124h80v63l240-183 440 336-48 63-72-54v375H160Zm80-80h200v-160h80v160h200v-356L480-739 240-556v356Zm-80-560q0-50 35-85t85-35q17 0 28.5-11.5T320-920h80q0 50-35 85t-85 35q-17 0-28.5 11.5T240-760h-80Zm80 560h480-480Z" />
          </svg>
          <span>House Sitting</span>
        </a>
      </li>
      <li class="active">
        <a href="DropInVisits.html">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed">
            <path
              d="M380-80q-59 0-99.5-40.5T240-220q0-9 2.5-14t-.5-8q-3-3-8-.5t-14 2.5q-59 0-99.5-40.5T80-380q0-59 40.5-99.5T220-520q23 0 42 6t36 18l166-166q-12-17-18-36t-6-42q0-59 40.5-99.5T580-880q59 0 99.5 40.5T720-740q0 9-2.5 14t.5 8q3 3 8 .5t14-2.5q59 0 99.5 40.5T880-580q0 59-40.5 99.5T740-440q-23 0-42-6t-36-18L496-298q12 17 18 36t6 42q0 59-40.5 99.5T380-80Zm0-80q26 0 43-17t17-43q0-9-2.5-17.5T430-254q-17-24-14-51.5t24-48.5l166-166q21-21 48.5-24t51.5 14q8 5 16.5 7.5T740-520q26 0 43-17t17-43q0-26-17-43t-43-17q-35 0-49-3.5T662-662q-15-15-18.5-29t-3.5-49q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 11 2 18.5t8 15.5q17 24 14 51.5T520-606L354-440q-21 21-48.5 24T254-430q-8-5-16.5-7.5T220-440q-26 0-43 17t-17 43q0 26 17 43t43 17q35 0 49 3.5t29 18.5q15 15 18.5 29t3.5 49q0 26 17 43t43 17Zm100-320Z" />
          </svg>
          <span>Drop-In Visits</span>
        </a>
      </li>
    </ul>
  </nav>
  <main>
    <a href="../PetTimer.html" style="text-decoration: none;">
      <button class="back-button">
        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed">
          <path d="m368-417 202 202-90 89-354-354 354-354 90 89-202 202h466v126H368Z" />
        </svg>
        <span style="color: white;">Back</span>
      </button>
    </a>

    <a href="../PetTimer.html#drop-in-visits-form" style="margin-left: 1em; text-decoration: none;">
      <button class="back-button">
        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed">
          <path
            d="M680-80v-120H560v-80h120v-120h80v120h120v80H760v120h-80Zm-480-80q-33 0-56.5-23.5T120-240v-480q0-33 23.5-56.5T200-800h40v-80h80v80h240v-80h80v80h40q33 0 56.5 23.5T760-720v244q-20-3-40-3t-40 3v-84H200v320h280q0 20 3 40t11 40H200Zm0-480h480v-80H200v80Zm0 0v-80 80Z" />
        </svg>
        <span style="color: white;">Book Drop-In Visits</span>
      </button>
    </a>
    <div id="dropInVisits">
      <p>Loading...</p>
    </div>
  </main>

  <script>
    async function fetchDropInVisits() {
      const userId = localStorage.getItem('userId'); // Get userId from localStorage
      const response = await fetch(`/api/drop-in-visits/${userId}`);
      const dropInVisits = await response.json();
      const container = document.getElementById('dropInVisits');
      container.innerHTML = '';

      if (dropInVisits.length === 0) {
        container.innerHTML = '<p style="text-align: center; margin-top: 2em;">No Drop-In Visits forms have been created</p>';
        return;
      }

      // Sort visits by creation date in descending order
      dropInVisits.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      dropInVisits.forEach(visit => {
        const createdAt = new Date(visit.createdAt);
        console.log('Created At:', visit.createdAt, 'Parsed Date:', createdAt); // Debugging line
        const visitElement = document.createElement('div');
        visitElement.innerHTML = `
        <div class="container">
          <h2 style="line-height: 1.5;">
            ü¶¥ Drop-In Visits ‚Äì üìÖ ${createdAt.toLocaleDateString()} - ‚è∞ ${createdAt.toLocaleTimeString()}
          </h2>
          <div style="margin: 3em 0;">
            <p style="line-height: 1.5; display: flex; align-items: center;">
              <i class="fa fa-paw" style="width: 1.5em; margin-right: 0.5em;"></i>
              <strong style="margin-right: 0.5em;">Pet Type:</strong> ${visit.petType.map(type => type.charAt(0).toUpperCase() + type.slice(1)).join(' and ')}
            </p>
            <p style="line-height: 1.5; display: flex; align-items: center;">
              <i class="fa fa-users" style="width: 1.5em; margin-right: 0.5em;"></i>
              <strong style="margin-right: 0.5em;">Number of pets:</strong> ${visit.spacesRequired}
            </p>
            <p style="line-height: 1.5; display: flex; align-items: center;">
              <i class="fa fa-map-marker" style="width: 1.5em; margin-right: 0.5em;"></i>
              <strong style="margin-right: 0.5em;">Address:</strong> ${visit.dropInVisitAddress || 'N/A'}
            </p>
            <p style="line-height: 1.5; display: flex; align-items: center;">
              <i class="fa fa-calendar-check" style="width: 1.5em; margin-right: 0.5em;"></i>
              <strong style="margin-right: 0.5em;">Service Frequency:</strong> ${visit.serviceFrequency}
            </p>
            ${visit.serviceFrequency === 'one-time' ? `
              <p style="line-height: 1.5; display: flex; align-items: center;">
                <i class="fa fa-sign-in-alt" style="width: 1.5em; margin-right: 0.5em;"></i>
                <strong style="margin-right: 0.5em;">Drop off:</strong> ${new Date(visit.fromDate).toLocaleDateString()}
              </p>
              <p style="line-height: 1.5; display: flex; align-items: center;">
                <i class="fa fa-sign-out-alt" style="width: 1.5em; margin-right: 0.5em;"></i>
                <strong style="margin-right: 0.5em;">Pick up:</strong> ${new Date(visit.toDate).toLocaleDateString()}
              </p>
            ` : `
              <p style="line-height: 1.5; display: flex; align-items: center;">
                <i class="fa fa-sync-alt" style="width: 1.5em; margin-right: 0.5em;"></i>
                <strong style="margin-right: 0.5em;">Repeat Weekly on:</strong> ${visit.days.join(', ')}
              </p>
              <p style="line-height: 1.5; display: flex; align-items: center;">
                <i class="fa fa-calendar-day" style="width: 1.5em; margin-right: 0.5em;"></i>
                <strong style="margin-right: 0.5em;">Start Date:</strong> ${new Date(visit.startDate).toLocaleDateString()}
              </p>
            `}
            <p style="line-height: 1.5; display: flex; align-items: center;">
              <i class="fa fa-info-circle" style="width: 1.5em; margin-right: 0.5em;"></i>
              <strong style="margin-right: 0.5em;">Condition / Description:</strong> 
            </p>
            ${visit.dropInVisitCondition || 'N/A'}
          </div>

          <div class="button-container">
            <a href="#">
              <button class="view-button">View</button>
            </a>
            <button class="delete-button" onclick="deleteVisit('${visit._id}')">Delete</button>
          </div>
        </div>
        `;
        container.appendChild(visitElement);
      });
    }

    async function deleteVisit(id) {
      if (!confirm('Are you sure you want to delete this entry?')) {
        return;
      }
      const response = await fetch(`/api/drop-in-visits/${id}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        fetchDropInVisits(); // Refresh the list after deletion
      } else {
        alert('Failed to delete the visit');
      }
    }

    fetchDropInVisits();
  </script>
</body>

</html>