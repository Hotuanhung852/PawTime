<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PawTime</title>
    <link rel="stylesheet" href="../assets/css/viewbookingservice.css">
    <link rel="stylesheet" href="../assets/css/petboardingdetail.css">
    <script type="text/javascript" src="./assets/js/app.js" defer></script>
    <!-- 
    - favicon
    -->
    <link rel="shortcut icon" href="../favicon.svg" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Font Awesome CDN-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
</head>

<body>
    <nav id="sidebar">
        <ul>
            <li>
                <span class="logo">PawTime</span>
                <button onclick=toggleSidebar() id="toggle-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="#e8eaed">
                        <path
                            d="m313-480 155 156q11 11 11.5 27.5T468-268q-11 11-28 11t-28-11L228-452q-6-6-8.5-13t-2.5-15q0-8 2.5-15t8.5-13l184-184q11-11 27.5-11.5T468-692q11 11 11 28t-11 28L313-480Zm264 0 155 156q11 11 11.5 27.5T732-268q-11 11-28 11t-28-11L492-452q-6-6-8.5-13t-2.5-15q0-8 2.5-15t8.5-13l184-184q11-11 27.5-11.5T732-692q11 11 11 28t-11 28L577-480Z" />
                    </svg>
                </button>
            </li>
            <li>
                <a href="./ViewBookingService/PetBoarding.html">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="#e8eaed">
                        <path
                            d="M160-120q-33 0-56.5-23.5T80-200v-440q0-33 23.5-56.5T160-720h160v-80q0-33 23.5-56.5T400-880h160q33 0 56.5 23.5T640-800v80h160q33 0 56.5 23.5T880-640v440q0 33-23.5 56.5T800-120H160Zm240-600h160v-80H400v80Zm-160 80h-80v440h80v-440Zm400 440v-440H320v440h320Zm80-440v440h80v-440h-80ZM480-420Z" />
                    </svg>
                    <span>Pet Boarding</span>
                </a>
            </li>
            <li class="active">
                <a href="./ViewBookingService/HouseSitting.html">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="#e8eaed">
                        <path
                            d="M160-120v-375l-72 55-48-64 120-92v-124h80v63l240-183 440 336-48 63-72-54v375H160Zm80-80h200v-160h80v160h200v-356L480-739 240-556v356Zm-80-560q0-50 35-85t85-35q17 0 28.5-11.5T320-920h80q0 50-35 85t-85 35q-17 0-28.5 11.5T240-760h-80Zm80 560h480-480Z" />
                    </svg>
                    <span>House Sitting</span>
                </a>
            </li>
            <li>
                <a href="./ViewBookingService/DropInVisits.html">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="#e8eaed">
                        <path
                            d="M380-80q-59 0-99.5-40.5T240-220q0-9 2.5-14t-.5-8q-3-3-8-.5t-14 2.5q-59 0-99.5-40.5T80-380q0-59 40.5-99.5T220-520q23 0 42 6t36 18l166-166q-12-17-18-36t-6-42q0-59 40.5-99.5T580-880q59 0 99.5 40.5T720-740q0 9-2.5 14t.5 8q3 3 8 .5t14-2.5q59 0 99.5 40.5T880-580q0 59-40.5 99.5T740-440q-23 0-42-6t-36-18L496-298q12 17 18 36t6 42q0 59-40.5 99.5T380-80Zm0-80q26 0 43-17t17-43q0-9-2.5-17.5T430-254q-17-24-14-51.5t24-48.5l166-166q21-21 48.5-24t51.5 14q8 5 16.5 7.5T740-520q26 0 43-17t17-43q0-26-17-43t-43-17q-35 0-49-3.5T662-662q-15-15-18.5-29t-3.5-49q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 11 2 18.5t8 15.5q17 24 14 51.5T520-606L354-440q-21 21-48.5 24T254-430q-8-5-16.5-7.5T220-440q-26 0-43 17t-17 43q0 26 17 43t43 17q35 0 49 3.5t29 18.5q15 15 18.5 29t3.5 49q0 26 17 43t43 17Zm100-320Z" />
                    </svg>
                    <span>Drop-In Visits</span>
                </a>
            </li>
        </ul>
    </nav>

    <main>
        <a href="./ViewBookingService/PetBoarding.html" style="text-decoration: none;">
            <button class="back-button">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                    fill="#e8eaed">
                    <path d="m368-417 202 202-90 89-354-354 354-354 90 89-202 202h466v126H368Z" />
                </svg>
                <span style="color: white;">Back</span>
            </button>
        </a>

        <h1>House Sitting Details</h1>
        <div id="houseSittingDetails">
            <!-- House sitting requests will be displayed here -->
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const userId = localStorage.getItem('userId'); // Retrieve the user ID from localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const houseSittingId = urlParams.get('id');

            if (!userId) {
                alert('User not logged in');
                return;
            }

            try {
                const response = await fetch(`/house-sitting-requests/${houseSittingId}`);
                const requests = await response.json();
                console.log('Fetched requests:', requests); // Debugging: Log the fetched requests

                if (response.ok) {
                    const detailsContainer = document.getElementById('houseSittingDetails');
                    detailsContainer.innerHTML = ''; // Clear the loading text

                    if (requests.length === 0) {
                        detailsContainer.innerHTML = '<p style="text-align: center; margin-top: 2em;">No requests have been made</p>';
                    } else {
                        requests.forEach(request => {
                            const petSitter = request.petSitterId;
                            const requestDiv = document.createElement('div');
                            requestDiv.innerHTML = `
                                <div class="card">
                                    <div class="card-body">
                                        <h3 class="h3 section-title" style="margin: 1em 0;">
                                            Pet Sitter Request
                                        </h3>
                                        <section style="display: flex; justify-content: center;">
                                            <div class="card__container">
                                                <div class="card__content">
                                                    <div class="card__body">
                                                        <h1>Bio:</h1>
                                                        <p class="card__text">${petSitter.bio || 'No bio available'}</p>
                                                    </div>
                                                    <div class="card__footer">
                                                        <div class="user">
                                                            <img src="${petSitter.avatar || './default-avatar.png'}" alt="user__image" class="user__image">
                                                            <div class="user__info">
                                                                <h1>${petSitter.fullname}</h1>
                                                                <h3 style="margin-top: 1em; margin-left: 0.7em;"><i class="fa-solid fa-phone"></i> ${petSitter.phoneNumber}</h3>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="social-media-links">
                                                        ${petSitter.socialLinks.facebook ? `<a href="${petSitter.socialLinks.facebook}" target="_blank"><i class="fa-brands fa-facebook"></i></a>` : ''}
                                                        ${petSitter.socialLinks.instagram ? `<a href="${petSitter.socialLinks.instagram}" target="_blank"><i class="fa-brands fa-instagram"></i></a>` : ''}
                                                        ${petSitter.socialLinks.tiktok ? `<a href="${petSitter.socialLinks.tiktok}" target="_blank"><i class="fa-brands fa-tiktok"></i></a>` : ''}
                                                        ${petSitter.socialLinks.twitter ? `<a href="${petSitter.socialLinks.twitter}" target="_blank"><i class="fa-brands fa-twitter"></i></a>` : ''}
                                                    </div>
                                                    <div class="card__actions">
                                                        ${request.status === 'pending' ? `
                                                            <button class="btn accept-btn" onclick="acceptRequest('${request._id}')">
                                                                <i class="fa-solid fa-check"></i> Accept
                                                            </button>
                                                        ` : `
                                                            <button class="btn approve-btn" onclick="updateRequestStatus('${request._id}', 'approved')">
                                                                <i class="fa-solid fa-thumbs-up"></i> Approve
                                                            </button>
                                                            <button class="btn disapprove-btn" onclick="updateRequestStatus('${request._id}', 'disapproved')">
                                                                <i class="fa-solid fa-thumbs-down"></i> Disapprove
                                                            </button>
                                                        `}
                                                    </div>
                                                    <div id="accept-message-${request._id}" style="display: none; color: green; margin-top: 10px;">
                                                        Accept successfully!
                                                    </div>
                                                </div>
                                            </div>
                                        </section>
                                    </div>
                                </div>
                            `;
                            detailsContainer.appendChild(requestDiv);
                        });
                    }
                } else {
                    alert('Failed to load requests: ' + requests.message);
                }
            } catch (error) {
                alert('Failed to load requests: ' + error.message);
            }
        });

        async function acceptRequest(requestId) {
            try {
                const response = await fetch(`/house-sitting-request/${requestId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'accepted' })
                });
                const result = await response.json();
                alert(result.message);
                location.reload(); // Reload the page to reflect the changes
            } catch (error) {
                alert('Failed to accept request: ' + error.message);
            }
        }

        async function updateRequestStatus(requestId, status) {
            try {
                const response = await fetch(`/house-sitting-request/${requestId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                const result = await response.json();
                alert(result.message);
                location.reload(); // Reload the page to reflect the changes
            } catch (error) {
                alert('Failed to update request status: ' + error.message);
            }
        }
    </script>
</body>

</html>