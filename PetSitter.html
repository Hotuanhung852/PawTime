<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PawTime</title>
    <link rel="stylesheet" href="../assets/css/petsitter.css">
    <script type="text/javascript" src="./assets/js/app.js" defer></script>
    <!-- 
    - favicon
    -->
    <link rel="shortcut icon" href="../favicon.svg" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
</head>

<body>
    <nav id="sidebar">
        <ul>
            <li>
                <span class="logo">Pet Sitter</span>
                <button onclick=toggleSidebar() id="toggle-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="#e8eaed">
                        <path
                            d="m313-480 155 156q11 11 11.5 27.5T468-268q-11 11-28 11t-28-11L228-452q-6-6-8.5-13t-2.5-15q0-8 2.5-15t8.5-13l184-184q11-11 27.5-11.5T468-692q11 11 11 28t-11 28L313-480Zm264 0 155 156q11 11 11.5 27.5T732-268q-11 11-28 11t-28-11L492-452q-6-6-8.5-13t-2.5-15q0-8 2.5-15t8.5-13l184-184q11-11 27.5-11.5T732-692q11 11 11 28t-11 28L577-480Z" />
                    </svg>
                </button>
            </li>
            <li class="active">
                <a href="PetSitter.html">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="#e8eaed">
                        <path
                            d="M560-680v-80h320v80H560Zm0 160v-80h320v80H560Zm0 160v-80h320v80H560Zm-240-40q-50 0-85-35t-35-85q0-50 35-85t85-35q50 0 85 35t35 85q0 50-35 85t-85 35ZM80-160v-76q0-21 10-40t28-30q45-27 95.5-40.5T320-360q56 0 106.5 13.5T522-306q18 11 28 30t10 40v76H80Z" />
                    </svg>
                    <span>Service Request Post</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="#e8eaed">
                        <path
                            d="M480-120q-138 0-240.5-91.5T122-440h82q14 104 92.5 172T480-200q117 0 198.5-81.5T760-480q0-117-81.5-198.5T480-760q-69 0-129 32t-101 88h110v80H120v-240h80v94q51-64 124.5-99T480-840q75 0 140.5 28.5t114 77q48.5 48.5 77 114T840-480q0 75-28.5 140.5t-77 114q-48.5 48.5-114 77T480-120Zm112-192L440-464v-216h80v184l128 128-56 56Z" />
                    </svg>
                    <span>History</span>
                </a>
            </li>
        </ul>
    </nav>

    <main>
        <a href="../PetTimer.html" style="text-decoration: none;">
            <button class="back-button">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                    fill="#e8eaed">
                    <path d="m368-417 202 202-90 89-354-354 354-354 90 89-202 202h466v126H368Z" />
                </svg>
                <span style="color: white;">Back</span>
            </button>
        </a>
        <div id="petBoardingDetails">
            <!-- Pet boarding details will be displayed here -->
        </div>
    </main>

    <script>
        // Check if user is logged in and has the correct role
        function checkPetSitterAuth() {
            const isLoggedIn = localStorage.getItem('loggedIn');
            const userRole = localStorage.getItem('userRole');

            if (!isLoggedIn || userRole !== 'pet_sitter') {
                alert('Access denied. Only pet sitters can access this page.');
                window.location.href = 'index.html';
            } else {
                fetchPetBoardingData();
            }
        }

        // Fetch all pet boarding data
        async function fetchPetBoardingData() {
            try {
                const response = await fetch('/all-pet-boarding');
                const data = await response.json();
                console.log('Fetched data:', data); // Debugging: Log the fetched data

                const detailsContainer = document.getElementById('petBoardingDetails');
                detailsContainer.innerHTML = ''; // Clear the loading text

                if (response.ok) {
                    if (data.length === 0) {
                        detailsContainer.innerHTML = '<p style="text-align: center; margin-top: 2em;">No pet boarding forms have been created</p>';
                    } else {
                        data.forEach(item => {
                            const createdAt = new Date(item.createdAt);
                            const dropOffDate = new Date(item.dropOffDate);
                            const pickUpDate = new Date(item.pickUpDate);

                            const detailDiv = document.createElement('div');
                            detailDiv.innerHTML = `
                                <div class="container">
                                    <h2 style="line-height: 1.5;">
                                        Pet Boarding â€“ ${createdAt.toLocaleDateString()} - ${createdAt.toLocaleTimeString()}
                                    </h2>
                                    <div style="margin: 3em 0;">
                                        <p style="line-height: 1.5;">
                                        - <strong>Pet Type:</strong> ${item.petType || 'N/A'}
                                        </p>
                                        <p style="line-height: 1.5;">
                                        - <strong>Number of pets:</strong> ${item.petCount || 'N/A'}
                                        </p>
                                        <p style="line-height: 1.5;">
                                        - <strong>Address:</strong> ${item.address || 'N/A'}
                                        </p>
                                        <p style="line-height: 1.5;">
                                        - <strong>Drop off:</strong> ${isNaN(dropOffDate) ? 'N/A' : dropOffDate.toLocaleDateString()}
                                        </p>
                                        <p style="line-height: 1.5;">
                                        - <strong>Pick up:</strong> ${isNaN(pickUpDate) ? 'N/A' : pickUpDate.toLocaleDateString()}
                                        </p>
                                        <p style="line-height: 1.5;">
                                        - <strong>Condition / Description (optional):</strong> ${item.condition || 'None'}
                                        </p>
                                    </div>
                                    <div class="button-container">
                                        <details>
                                        <summary>
                                            <div class="button">
                                            <i class="fa-solid fa-user"></i> View Profile
                                            </div>
                                            <div class="details-modal-overlay"></div>
                                        </summary>
                                        <div class="details-modal" id="modal-${item.userId}">
                                            <div class="details-modal-title">
                                            <h1>Loading...</h1>
                                            <h1>Loading...</h1>
                                            </div>
                                            <div class="details-modal-content">
                                            <p>
                                                - Loading...
                                            </p>
                                            <p>
                                                - Loading...
                                            </p>
                                        </div>
                                        </div>
                                        </details>
                                        <button class="btn green-bg" onclick="toggleButtonRequest(this)">
                                        <i class="fa-solid fa-file-alt"></i> Request Apply
                                        </button>
                                    </div>
                                </div>
                            `;
                            detailsContainer.appendChild(detailDiv);
                            fetchUserDetails(item.userId);
                        });
                    }
                } else {
                    alert('Failed to load pet boarding details: ' + data.message);
                }
            } catch (error) {
                alert('Failed to load pet boarding details: ' + error.message);
            }
        }

        // Fetch user details and update the modal
        async function fetchUserDetails(userId) {
            try {
                const response = await fetch(`/user/${userId}`);
                const user = await response.json();
                console.log('Fetched user:', user); // Debugging: Log the fetched user

                if (response.ok) {
                    const modal = document.getElementById(`modal-${userId}`);
                    modal.querySelector('.details-modal-title').innerHTML = `
                        <h1>${user.fullname}</h1>
                        <h1>
                            <i class="fa-solid fa-phone"></i> ${user.phoneNumber}
                        </h1>
                    `;
                    modal.querySelector('.details-modal-content').innerHTML = `
                        <p>
                            ${user.bio || 'No bio available'}
                        </p>
                        <p>
                            ${user.socialLinks.facebook ? `<a href="${user.socialLinks.facebook}" target="_blank"><i class="fab fa-facebook"></i> Facebook</a>` : 'No social links'}
                        </p>
                        <p>
                            ${user.socialLinks.instagram ? `<a href="${user.socialLinks.instagram}" target="_blank"><i class="fab fa-instagram"></i> Instagram</a>` : ''}
                        </p>
                        <p>
                            ${user.socialLinks.twitter ? `<a href="${user.socialLinks.twitter}" target="_blank"><i class="fab fa-twitter"></i> Twitter</a>` : ''}
                        </p>
                        <p>
                            ${user.socialLinks.tiktok ? `<a href="${user.socialLinks.tiktok}" target="_blank"><i class="fab fa-tiktok"></i> TikTok</a>` : ''}
                        </p>
                        `;
                } else {
                    alert('Failed to load user details: ' + user.message);
                }
            } catch (error) {
                alert('Failed to load user details: ' + error.message);
            }
        }

        // Toggle button function
        function toggleButtonRequest(button) {
            if (button.classList.contains('green-bg')) {
                button.classList.remove('green-bg');
                button.classList.add('red-bg');
                button.innerHTML = '<i class="fa-solid fa-times"></i> Cancel Apply';
            } else {
                button.classList.remove('red-bg');
                button.classList.add('green-bg');
                button.innerHTML = '<i class="fa-solid fa-file-alt"></i> Request Apply';
            }
        }

        // Run check when page loads
        document.addEventListener('DOMContentLoaded', checkPetSitterAuth);
    </script>
</body>

</html>